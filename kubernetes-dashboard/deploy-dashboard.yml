---
- name: Deploy Kubernetes Dashboard
  hosts: localhost
  gather_facts: false
  connection: local

  vars:
    dashboard_version: "v2.7.0"
    dashboard_namespace: "kubernetes-dashboard"
    service_account_name: "dashboard-admin"

  tasks:
    - name: Check if kubectl is available
      command: which kubectl
      register: kubectl_check
      changed_when: false
      failed_when: kubectl_check.rc != 0

    - name: Display kubectl version
      command: kubectl version --client
      register: kubectl_version
      changed_when: false
      failed_when: false

    - name: Display kubectl version info
      debug:
        msg: "Using kubectl: {{ kubectl_version.stdout_lines[0] | default('Version info unavailable') }}"

    - name: Check if dashboard namespace exists
      command: kubectl get namespace {{ dashboard_namespace }}
      register: namespace_check
      changed_when: false
      failed_when: false

    - name: Create dashboard namespace
      command: kubectl create namespace {{ dashboard_namespace }}
      when: namespace_check.rc != 0
      register: namespace_created

    - name: Deploy Kubernetes Dashboard
      command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/{{ dashboard_version }}/aio/deploy/recommended.yaml
      register: dashboard_deployed
      changed_when: "'created' in dashboard_deployed.stdout or 'configured' in dashboard_deployed.stdout"

    - name: Wait for dashboard deployment to be ready
      command: kubectl wait --for=condition=available --timeout=300s deployment/kubernetes-dashboard -n {{ dashboard_namespace }}
      when: dashboard_deployed.changed | default(false)
      register: dashboard_ready
      failed_when: dashboard_ready.rc != 0
      retries: 10
      delay: 30

    - name: Check if service account exists
      command: kubectl get serviceaccount {{ service_account_name }} -n {{ dashboard_namespace }}
      register: sa_check
      changed_when: false
      failed_when: false

    - name: Create dashboard admin service account
      command: kubectl create serviceaccount {{ service_account_name }} -n {{ dashboard_namespace }}
      when: sa_check.rc != 0
      register: sa_created

    - name: Check if cluster role binding exists
      command: kubectl get clusterrolebinding dashboard-admin
      register: crb_check
      changed_when: false
      failed_when: false

    - name: Create cluster role binding for dashboard admin
      command: kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount={{ dashboard_namespace }}:{{ service_account_name }}
      when: crb_check.rc != 0
      register: crb_created

    - name: Get dashboard admin token
      command: kubectl -n {{ dashboard_namespace }} create token {{ service_account_name }} --duration=8760h
      register: dashboard_token
      changed_when: false
      no_log: false  # We want to display the token

    - name: Get dashboard service information
      command: kubectl get svc kubernetes-dashboard -n {{ dashboard_namespace }} -o jsonpath='{.spec.type}'
      register: svc_type
      changed_when: false

    - name: Get dashboard service details
      command: kubectl get svc kubernetes-dashboard -n {{ dashboard_namespace }}
      register: svc_info
      changed_when: false

    - name: Display deployment summary
      debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Kubernetes Dashboard Deployment Complete"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Dashboard Version: {{ dashboard_version }}"
          - "Namespace: {{ dashboard_namespace }}"
          - "Service Account: {{ service_account_name }}"
          - ""
          - "Service Information:"
          - "{{ svc_info.stdout_lines | join('\n') }}"
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Access Instructions:"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Option 1: Port Forward (Recommended for local access)"
          - "  kubectl port-forward -n {{ dashboard_namespace }} svc/kubernetes-dashboard 8443:443"
          - "  Then open: https://localhost:8443"
          - ""
          - "Option 2: If using LoadBalancer (check service type above)"
          - "  Get external IP: kubectl get svc kubernetes-dashboard -n {{ dashboard_namespace }}"
          - "  Access: https://<EXTERNAL-IP>"
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Authentication Token:"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "{{ dashboard_token.stdout }}"
          - ""
          - "Copy this token and paste it into the dashboard login screen."
          - "Token is valid for 1 year (8760 hours)."
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Quick Access Script:"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Run: ./access-dashboard.sh"
          - "This will set up port-forwarding and display the token."
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

