---
- name: Fetch Kubeconfig from Kubernetes Master
  hosts: control_plane
  become: yes
  gather_facts: yes
  remote_user: ansible  # Uses default ansible user from ansible.cfg

  vars:
    master_node: "k8s-master"

  pre_tasks:
    - name: Set master IP fact
      set_fact:
        master_ip: "{{ hostvars[master_node]['ansible_host'] }}"

  tasks:
    - name: Verify k3s kubeconfig exists on master
      stat:
        path: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_stat
      failed_when: not kubeconfig_stat.stat.exists

    - name: Display kubeconfig location
      debug:
        msg: "Found kubeconfig at /etc/rancher/k3s/k3s.yaml on {{ inventory_hostname }}"

    - name: Read kubeconfig from master node
      slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_content
      # slurp reads from the remote host (k8s-master) with become privileges

    - name: Ensure ~/.kube directory exists
      shell: |
        mkdir -p ~/.kube
      delegate_to: localhost
      become: false
      run_once: true
      # Create .kube directory in user's home on localhost

    - name: Write kubeconfig to default location (~/.kube/config)
      shell: |
        cat > ~/.kube/config << 'EOF'
        {{ kubeconfig_content.content | b64decode }}
        EOF
        chmod 600 ~/.kube/config
      delegate_to: localhost
      become: false
      run_once: true
      register: kubeconfig_written
      # Use shell to write file to default kubectl location on localhost without become

    - name: Update kubeconfig server address in fetched file
      shell: |
        sed -i '' 's|https://127.0.0.1:6443|https://{{ master_ip }}:6443|g' ~/.kube/config
      when: kubeconfig_written.changed | default(false)
      delegate_to: localhost
      become: false
      run_once: true
      # Use shell to update file on localhost without become (macOS sed requires empty backup extension)

    - name: Display kubeconfig setup confirmation
      debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Kubeconfig Fetched Successfully"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Kubeconfig file has been saved to:"
          - "  ~/.kube/config"
          - ""
          - "You can now use kubectl directly without setting KUBECONFIG:"
          - "  kubectl get nodes"
          - "  kubectl get pods --all-namespaces"
          - ""
          - "The server address has been updated from 127.0.0.1 to {{ master_ip }}"
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      run_once: true

