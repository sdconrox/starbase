---
- name: Deploy Kubernetes Cluster on Raspberry Pi 4s
  hosts: raspberry_pi_cluster
  become: yes
  gather_facts: yes
  remote_user: ansible

  vars:
    # Kubernetes configuration
    kubernetes_version: "1.34"  # Kubernetes version (k3s v1.34.3+k3s1 supports K8s 1.34.3)
    k3s_version: "v1.34.3+k3s1"  # Latest stable k3s version - use specific version instead of "latest" to avoid download failures
    use_k3s: true  # Set to false to use full k8s instead

    # Network configuration
    cluster_cidr: "10.42.0.0/16"
    service_cidr: "10.43.0.0/16"

    # Master node configuration (Proxmox VM)
    # Note: Master is x86_64 (Proxmox VM), workers are ARM (Raspberry Pi)
    # k3s supports mixed architecture clusters
    master_node: "k8s-master"

  pre_tasks:
    - name: Set master IP fact
      set_fact:
        master_ip: "{{ hostvars[master_node]['ansible_host'] }}"

  roles:
    - role: common
    - role: kubernetes

  post_tasks:
    - name: Display cluster information
      debug:
        msg: "Kubernetes cluster deployment complete. Master node: {{ master_node }} ({{ master_ip }})"

    - name: Display kubeconfig fetch instructions
      debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Cluster Deployment Complete"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "To fetch the kubeconfig and configure kubectl, run:"
          - "  ansible-playbook playbooks/fetch-kubeconfig.yml"
          - ""
          - "This will download the kubeconfig to ~/.kube/config so kubectl works automatically."
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      when: inventory_hostname in groups['control_plane']
      run_once: true

