---
- name: Deploy Kubernetes Cluster on Raspberry Pi 4s
  hosts: raspberry_pi_cluster
  become: yes
  gather_facts: yes
  remote_user: ansible

  vars:
    master_node: "k8s-master-primary"

  pre_tasks:
    - name: Set master IP fact
      set_fact:
        master_ip: "{{ hostvars[master_node]['ansible_host'] }}"

  roles:
    - role: common
    - role: kubernetes

  post_tasks:
    - name: Display cluster information
      debug:
        msg: "Kubernetes cluster deployment complete. Master node: {{ master_node }} ({{ master_ip }})"

    - name: Display kubeconfig fetch instructions
      debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Cluster Deployment Complete"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "To fetch the kubeconfig and configure kubectl, run:"
          - "  ansible-playbook playbooks/fetch-kubeconfig.yml"
          - ""
          - "This will download the kubeconfig to ~/.kube/config so kubectl works automatically."
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      when: inventory_hostname in groups['control_plane']
      run_once: true

